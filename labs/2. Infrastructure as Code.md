# Infrastructure as Code

These exercies will introduce you to the concept of Infrastructure as Code (IaC) and how to use it to deploy and manage Azure resources. We will be using Bicep, a domain-specific language (DSL) for deploying Azure resources, which is a more concise and easier to read alternative to ARM templates.

### Prerequisites:
- Access to an Azure subscription and an Azure resource group with sufficient permissions to create resources in the resource group 
- Azure CLI installed and configured. See <a href="https://learn.microsoft.com/en-us/cli/azure/install-azure-cli-windows" target="_blank">here</a> for installation instructions. If you can't install the Azure CLI you could instead use the <a href="https://learn.microsoft.com/en-us/azure/cloud-shell/overview" target="_blank">Azure Cloud Shell in the Azure Portal</a>, which has the Azure CLI pre-installed and configured. Changes you make to files in the Cloud Shell may or may not persist, so it's recommended to use a local installation of the Azure CLI if possible.
- Code editor of your choice (e.g. Visual Studio Code, Notepad++, etc.). If you are using VS Code make sure you install the Bicep extension for syntax highlighting and intellisense. See <a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/install" target="_blank">here</a> for installation instructions.


### Module 1 - Authoring Bicep and Deploying with Azure CLI

For these exercise will be using the Microsoft Learn modules for Bicep, which provide a great introduction to Bicep and cover all the key concepts and features of the language. All the links and steps below refer just to the exercises in the modules, but if you need a refresher on any of the concepts or features you can refer to the relevant module content.

The exercises all assume you are using VS Code, but they will work just as well with any code editor and a Powershell terminal with the Azure CLI installed and configured.

> Note
At the top of each module page you are able to select the CLI you will be using - make sure this is set to "Azure CLI". If you want to know more about the different CLI options click <a href="https://learn.microsoft.com/en-us/cli/azure/choose-the-right-azure-command-line-tool?view=azure-cli-latest" target="_blank">here</a>

You should also adjust the 'location' property of any resources you are deploying to a location that is available in your subscription and close to you. 

These exercises are designed to be completed in order within each module, as they build on each other and cover different aspects of Bicep and infrastructure as code. However, feel free to skip around and complete the exercises that are most relevant to you.

Clink on each link below to access the exercises for each module. Each will open in a new tab so that you can easily return to this page to access the next exercise when you are ready.

#### Build your first Bicep file
1. <a href="https://learn.microsoft.com/en-us/training/modules/build-first-bicep-file/4-exercise-define-resources-bicep-file/?ns-enrollment-type=learningpath&ns-enrollment-id=learn.bicep-deploy-manage&pivots=cli" target="_blank">Define resources in a Bicep file</a>

2. <a href="https://learn.microsoft.com/en-us/training/modules/build-first-bicep-file/6-exercise-add-parameters-variables-bicep-file/?ns-enrollment-type=learningpath&ns-enrollment-id=learn.bicep-deploy-manage&pivots=cli" target="_blank">Add parameters and variables to a Bicep file</a>

3. <a href="https://learn.microsoft.com/en-us/training/modules/build-first-bicep-file/8-exercise-refactor-file-modules/?ns-enrollment-type=learningpath&ns-enrollment-id=learn.bicep-deploy-manage&pivots=cli" target="_blank">Refactor your Bicep to use modules</a>

#### Build reusable Bicep files by using parameters

4. <a href="https://learn.microsoft.com/en-us/training/modules/build-reusable-bicep-files-parameters/3-exercise-add-parameters-with-decorators/?ns-enrollment-type=learningpath&ns-enrollment-id=learn.bicep-deploy-manage&pivots=cli" target="_blank">Add parameters with decorators</a>

5. <a href="https://learn.microsoft.com/en-us/training/modules/build-reusable-bicep-files-parameters/6-exercise-create-use-parameter-files/?ns-enrollment-type=learningpath&ns-enrollment-id=learn.bicep-deploy-manage&pivots=cli" target="_blank">Add a parameter file and secure parameters</a>

#### Build flexible Bicep files by using conditions and loops

6. <a href="https://learn.microsoft.com/en-us/training/modules/build-flexible-bicep-files-conditions-loops/3-exercise-conditions/?ns-enrollment-type=learningpath&ns-enrollment-id=learn.bicep-deploy-manage&pivots=cli" target="_blank">Deploy resources conditionally</a>

7. <a href="https://learn.microsoft.com/en-us/training/modules/build-flexible-bicep-files-conditions-loops/5-exercise-loops/?ns-enrollment-type=learningpath&ns-enrollment-id=learn.bicep-deploy-manage&pivots=cli" target="_blank">Deploy multiple resources using loops</a>

8. <a href="https://learn.microsoft.com/en-us/training/modules/build-flexible-bicep-files-conditions-loops/8-exercise-loops-variables-outputs/?ns-enrollment-type=learningpath&ns-enrollment-id=learn.bicep-deploy-manage&pivots=cli" target="_blank">Use variable and output loops</a>

### Module 2 - Deploying Bicep with Azure DevOps Pipelines

In this exercise we will deploy the Bicep files we created in Module 1 using an Azure DevOps pipeline. You have previously created an Azure DevOps pipline that deployed a simple Bicep file, so for this exercise you will update that pipeline to deploy the more complex Bicep file and parameters file you created in Module 1.

1. Upload the main Bicep file, module files and parameters file you created in Module 1 to your Azure DevOps repository. You can create a new folder in the root of your repository and upload them there - if you are sharing a repository with other students make sure to upload the files to a folder with a unique name (e.g. "infra-<yourname>") to avoid conflicts with other students uploading their files.

1. Update your Azure DevOps pipeline to deploy the Bicep file and parameters file you uploaded in the previous step. You can use the "Azure Resource Group Deployment" task in your pipeline to deploy the Bicep file:
    * Update the `templateFile` variable in your pipeline to point to the location of your Bicep file in your repository 
    * Create a new variable in your pipeline called `parametersFile` and set it to the location of your parameters file in your repository
    * Update the "Azure Resource Group Deployment" tasks in both the dev and prod stages of your pipeline to use the `parametersFile` variable you just created to specify the parameters file for the deployment. The property you need to update is called `csmParametersFile` and should be set to '$(parametersFile)'. The new task should look something like this:

    ``` yaml
                    - task: AzureResourceManagerTemplateDeployment@3
                      inputs:
                        azureResourceManagerConnection: '$(service-connection)'
                        resourceGroupName: '$(rgName)'
                        location: '$(location)'
                        csmFile: '$(templateFile)'
                        csmParametersFile: '$(parametersFile)'
    ```
1. Run your pipeline and verify that the Bicep file is deployed successfully and the resources are created in your Azure subscription. You can check the deployment logs in Azure DevOps for any errors or issues that may arise during the deployment.